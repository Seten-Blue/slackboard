<div class="trello-container">
  <!-- Header con gradiente animado -->
  <div class="trello-header">
    <div class="header-content">
      <div class="icon-wrapper">
        <svg class="trello-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="3" width="8" height="18" rx="2" fill="currentColor"/>
          <rect x="13" y="3" width="8" height="12" rx="2" fill="currentColor" opacity="0.7"/>
        </svg>
      </div>
      <h2 class="trello-title">Mis Tableros de Trello</h2>
      <p class="trello-subtitle">Gestiona tus proyectos y tareas</p>
    </div>
  </div>

  <!-- Estados: Loading, Error, Empty -->
  <div class="trello-content">
    <!-- Loading State -->
    <div *ngIf="isLoading" class="state-container">
      <div class="loading-spinner">
        <div class="spinner"></div>
        <p class="loading-text">Cargando tableros...</p>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="errorMsg && !isLoading" class="state-container">
      <div class="error-state">
        <svg class="error-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
          <path d="M12 8v4m0 4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <p class="error-text">{{ errorMsg }}</p>
        <button class="retry-button" (click)="loadBoards()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/>
          </svg>
          Reintentar
        </button>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="boards.length === 0 && !isLoading && !errorMsg" class="state-container">
      <div class="empty-state">
        <div class="empty-icon-wrapper">
          <svg class="empty-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
            <path d="M12 8v8m-4-4h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <p class="empty-text">No hay tableros disponibles</p>
        <p class="empty-subtext">Crea tu primer tablero en Trello</p>
        <a href="https://trello.com" target="_blank" class="create-button">
          Ir a Trello
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6m4-3h6v6m-11 5L21 3"/>
          </svg>
        </a>
      </div>
    </div>

    <!-- Boards Grid (sin tableros de pruebas) -->
    <div *ngIf="boards.length > 0 && !isLoading" class="boards-grid">
      <div *ngFor="let board of boards; let i = index" 
           class="board-card" 
           [style.animation-delay]="(i * 0.1) + 's'">
        
        <!-- Card Header -->
        <div class="board-header">
          <div class="board-color-bar" [style.background]="getBoardColor(board)"></div>
          <div class="board-header-content">
            <h3 class="board-name">{{ board.name }}</h3>
            <div class="board-badges">
              <span class="badge" *ngIf="board.prefs?.permissionLevel">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                {{ getPermissionLabel(board.prefs.permissionLevel) }}
              </span>
              <span class="badge badge-members" *ngIf="board.memberships?.length">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                {{ board.memberships.length }}
              </span>
            </div>
          </div>
        </div>

        <!-- Card Body -->
        <div class="board-body">
          <div class="board-stats">
            <div class="stat-item">
              <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                <line x1="16" y1="2" x2="16" y2="6"/>
                <line x1="8" y1="2" x2="8" y2="6"/>
                <line x1="3" y1="10" x2="21" y2="10"/>
              </svg>
              <span class="stat-label">Última actividad</span>
              <span class="stat-value">{{ getRelativeTime(board.dateLastActivity) }}</span>
            </div>

            <div class="stat-item" *ngIf="board.memberships?.[0]?.member?.fullName">
              <svg class="stat-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              <span class="stat-label">Propietario</span>
              <span class="stat-value">{{ board.memberships[0].member.fullName }}</span>
            </div>
          </div>

          <!-- Board ID (collapsible) -->
          <details class="board-details">
            <summary class="details-trigger">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
              Información técnica
            </summary>
            <div class="details-content">
              <div class="detail-row">
                <span class="detail-label">ID del tablero:</span>
                <code class="detail-code">{{ board.id }}</code>
              </div>
            </div>
          </details>
        </div>

        <!-- Card Footer -->
        <div class="board-footer">
          <a *ngIf="board.url" 
             [href]="board.url" 
             target="_blank" 
             class="board-link">
            <span>Abrir en Trello</span>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
              <polyline points="15 3 21 3 21 9"/>
              <line x1="10" y1="14" x2="21" y2="3"/>
            </svg>
          </a>
        </div>
      </div>
    </div>

    <!-- Modal de actividad de Trello (overlay + modal) -->
    <div *ngIf="selectedBoardId">
      <div class="activity-modal-overlay"></div>
      <div class="activity-modal">
        <div class="activity-header-row">
          <h3 class="activity-title">Actividad reciente del tablero</h3>
          <button class="close-activity-btn" (click)="selectedBoardId = null" title="Cerrar actividad">✕</button>
        </div>
        <div *ngIf="isLoadingActions" class="state-container">
          <div class="loading-spinner"><div class="spinner"></div><p class="loading-text">Cargando actividad...</p></div>
        </div>
        <div *ngIf="actionsError" class="error-state">
          <p class="error-text">{{ actionsError }}</p>
        </div>
        <table *ngIf="!isLoadingActions && !actionsError && boardActions.length > 0" class="activity-table">
          <thead>
            <tr>
              <th>Carpeta/Lista</th>
              <th>Acción</th>
              <th>Quién</th>
              <th>Cuándo</th>
              <th>Descripción</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let action of boardActions">
              <td>{{ action.data?.listAfter?.name || action.data?.list?.name || action.data?.card?.name || '-' }}</td>
              <td>{{ action.type }}</td>
              <td>{{ action.memberCreator?.fullName || action.memberCreator?.username || '-' }}</td>
              <td>{{ getRelativeTime(action.date) }}</td>
              <td>
                <span *ngIf="action.type === 'updateCard' && action.data?.old">Actualización de tarjeta</span>
                <span *ngIf="action.type === 'createCard'">Creación de tarjeta</span>
                <span *ngIf="action.type === 'commentCard'">Comentario: {{ action.data?.text }}</span>
                <span *ngIf="action.type === 'moveCardToBoard'">Movida a este tablero</span>
                <span *ngIf="action.type === 'moveCardFromBoard'">Movida desde otro tablero</span>
                <span *ngIf="!['updateCard','createCard','commentCard','moveCardToBoard','moveCardFromBoard'].includes(action.type)">-</span>
              </td>
            </tr>
          </tbody>
        </table>
        <div *ngIf="!isLoadingActions && !actionsError && boardActions.length === 0" class="empty-state">
          <p class="empty-text">Sin actividad reciente</p>
        </div>

        <!-- Tabla de avance por miembro (debajo del historial) -->
        <div class="progress-table-container" *ngIf="!isLoadingCards && boardCards.length > 0">
          <h4 class="progress-title">Avance por miembro</h4>
          <table class="progress-table">
            <thead>
              <tr>
                <th>Miembro</th>
                <th>Listo</th>
                <th>En proceso</th>
                <th>Pendiente</th>
                <th>Total</th>
                <th>% Avance</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let m of getMemberProgress()">
                <td>
                  <div class="progress-member">
                    <img *ngIf="m.avatarUrl" [src]="m.avatarUrl" class="progress-avatar" [alt]="m.name" />
                    <span *ngIf="!m.avatarUrl" class="progress-avatar">{{ m.name ? m.name.charAt(0).toUpperCase() : '?' }}</span>
                    <div style="display:inline-block; vertical-align:top; margin-left:8px;">
                      <div><b>{{ m.name }}</b></div>
                      <div *ngIf="m.username" style="font-size:11px; color:#888;">@{{ m.username }}</div>
                      <div *ngIf="m.email" style="font-size:11px; color:#888;">{{ m.email }}</div>
                    </div>
                  </div>
                </td>
                <td class="progress-status-done">{{ m.done }}</td>
                <td class="progress-status-doing">{{ m.doing }}</td>
                <td class="progress-status-todo">{{ m.todo }}</td>
                <td>{{ m.total }}</td>
                <td>
                  <div class="progress-bar-bg">
                    <div class="progress-bar" [ngClass]="getProgressColor(m.percent)" [style.width]="m.percent + '%'" [attr.title]="m.percent + '%'" ></div>
                  </div>
                  <span class="progress-label">{{ m.percent }}%</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div *ngIf="isLoadingCards" class="state-container"><div class="spinner"></div><p class="loading-text">Cargando avance...</p></div>
        <div *ngIf="!isLoadingCards && boardCards.length === 0 && !cardsError" class="empty-state"><p class="empty-text">Sin tarjetas asignadas</p></div>
        <div *ngIf="cardsError" class="error-state"><p class="error-text">{{ cardsError }}</p></div>
      </div>
    </div>

    <!-- Botón para cargar actividad de cada board (incluye tableros de pruebas) -->
    <div *ngIf="allBoards.length > 0 && !isLoading" class="activity-board-buttons">
      <span>Ver actividad de:</span>
      <button *ngFor="let board of allBoards" (click)="loadBoardActions(board.id)" [class.active]="selectedBoardId === board.id">
        {{ board.name }}
      </button>
    </div>
  </div>
</div>